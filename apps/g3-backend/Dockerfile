# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build g3-backend`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run --env-file ./apps/g3-backend/.env.local -p 3200:3200 -t g3-backend`.
FROM docker.io/node:lts-alpine

# Install Python, pip, and build tools
RUN apk add --update --no-cache python3 py3-pip build-base && \
    if [ ! -e /usr/bin/python ]; then ln -sf python3 /usr/bin/python ; fi && \
    if [ ! -e /usr/bin/pip ]; then ln -sf pip3 /usr/bin/pip ; fi

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

ENV HOST=0.0.0.0
ENV PORT=3200

WORKDIR /app

RUN addgroup --system g3-backend && \
    adduser --system -G g3-backend g3-backend

COPY dist/apps/g3-backend g3-backend/
COPY packages/shared/shared-database-schema/prisma g3-backend/prisma/
RUN chown -R g3-backend:g3-backend .

WORKDIR /app/g3-backend
RUN pnpx prisma generate --schema prisma/schema.prisma
RUN pnpm install
RUN pnpm add -D tsx

EXPOSE 3200

CMD [ "pnpm", "tsx", "main.js" ]
