# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build g3-worker`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run --env-file ./apps/g3-worker/.env.local -p 3100:3100 -t g3-worker`.
FROM node:20-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.5 \
    python3-pip \
    build-essential \
    && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

ENV HOST=0.0.0.0
ENV PORT=3100

WORKDIR /app

RUN groupadd -r g3-worker && useradd -r -g g3-worker g3-worker

COPY dist/apps/g3-worker g3-worker/
COPY packages/shared/shared-database-schema/prisma g3-worker/prisma/
RUN chown -R g3-worker:g3-worker .

WORKDIR /app/g3-worker
RUN pnpx prisma generate --schema prisma/schema.prisma
RUN pnpm install
RUN pnpm i -D tsx

EXPOSE 3100

CMD [ "pnpm", "exec", "tsx", "./main.js" ]
